05——node js 事件循环 & EventEmitter 类

1. node.js 是==单进程单线程==应用程序

2. node.js 几乎每个API 都是支持回调函数的

3. node.js 基本上所有的事件机制都是用设计模式中观察者模式实现

4. Node.js 相关概念

   1. 进程：

      - 狭义定义：  进程是正在运行的程序的实例

      - 广义定义： 

        进程是一个具有一定独立功能的程序关于某个数据集合的一次运行活动，它是操作系统动态执行的基本单元，在传统操作系统中，==进程既是基本的分配单元，也是基本的执行单元==

      - 理解：

        1. 单个CPU 一次只能运行一个任务
        2. 任一时刻，CPU 总是运行一个进程，其他进程处于非运行状态
        3. 一个进程可以包括多个线程
        4. ==单线程并不是说只有一个线程，而是指： 只有一个主线程==

5. 单线程==缺点：

   - 如果 php 代码损坏，不会拖垮整个服务器。当某个请求错误时，只对特定的请求产生影响，而在 node.js 中，所有请求均在单一的进程服务中，当某个请求导致未知错误时，整个服务器都会受到影响
   - php 进程短暂，不必为资源配置和内存而担忧，，node.js 的进程需要运行很长一段时间，需小心并妥善管理好内存（会导致内存泄露）

6. 单线程==优点：

   - 高性能：
     1. 避免了传统PHP 那样频繁创建、切换线程的开销，使执行速度更加迅速
     2. 资源占用小
   - 线程安全：
     1. 不用担心同一变量同时被多个线程进行读写而造成的程序崩溃
     2. 解放了开发人员，免去了多线程编程中忘记对变量加锁或解锁造成的悲剧

7. 同步 /  异步 和  阻塞 /  非阻塞

   1. 同步阻塞：发起调用后，没有返回，并且把线程挂起等返回和结果一起返回
   2. 异步阻塞：发起调用后，返回了并且也会通知结果返回，但把线程挂起等结果一起返回
   3. 同步非阻塞：发起调用后，没有返回，虽没把线程挂起只能等返回和结果一起返回
   4. 异步非阻塞：发起调用，返回了并也会通知结果返回，没有挂起线程所以可以去做别的事情
   5. ==调用的返回和结果是不一样的，等调用后的返回和阻塞 / 非阻塞 有关；调用后的结果返回和同步 / 异步 有关==

8. JS 中的异步运行机制：

   - 所有同步任务都在主线程上执行，形成一个执行栈
   - 主线程之外，还存在一个“任务队列“（task queue）只要异步任务有了运行结果，就在”任务队列”之中放置一个事件
   - 一旦“执行栈”中的所有同步任务执行完毕，系统就会读取“任务队列”，看里面有哪些事件，哪些对应的异步任务，于是结束等待状态，进入执行栈开始执行
   - 主线程不断重复上面的第三步

9. Node.js 的 Event Loop （事件循环或事件轮询）：

   - 是一个程序结构，用于等待和发送消息

     就是在程序中设置两个进程：一个负责程序本身的运行，称为“主线程”；另一个负责主线程与其他进程（主要是各种 I/O 操作）的通信，被称为“Event Loop 线程“（消息线程）

   - 理解：

     Node.js 使用驱动模型，当web server 接收到请求，就把它关闭然后进行处理，然后去服务下一个web请求

     ==当这个请求完成，它被返回，处理队列（或称为 事件队列），当到达队列开头，这个结果被返回给用户==

10. Node.js 的 EventEmitter

    - Node.js 里面的许多对象都会分发事件：一个 net.Server 对象会在每次有新连接时触发一个事件；一个 fs.readStream 对象会在文件被打开是触发一个事件

      所有这些产生事件的对象都是 events.EventEmitter 的实例

    - EventEmitter 类

      1. events 模块只提供了一个对象：events.EventEmitter 
      2. EventEmitter 的核心：事件触发与事件监听器功能的封装
      3. 可通过 require("events") 访问该模块

    - 补充：

      1. 对于每个事件，EventEmitter 支持若干个事件监听器
      2. 当事件触发时，注册到这个事件的事件监听器被依次调用，事件参数作为回调函数参数传递